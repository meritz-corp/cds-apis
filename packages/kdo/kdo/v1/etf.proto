syntax = "proto3";

package kdo.v1.etf;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/empty.proto";
import "google/api/resource.proto";
import "google/api/client.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1;kdo";

// EtfService는 ETF 및 선물 관련 서비스를 제공합니다.
service EtfService {
    rpc GetEtf(GetEtfRequest) returns (Etf) {
        option (google.api.http) = {
            get: "/v1/{etf=etfs/*}"
        };
        option (google.api.method_signature) = "etf";
    }

    rpc ListEtfs(ListEtfsRequest) returns (ListEtfsResponse) {
        option (google.api.http) = {
            get: "/v1/etfs"
        };
        option (google.api.method_signature) = "";
    }

    // ETF Quote Strategy 업데이트
    rpc GetEtfQuoteStrategy(GetEtfQuoteStrategyRequest) returns (EtfQuoteStrategy) {
        option (google.api.http) = {
            get: "/v1/{etf=etfs/*}/quote_strategy"
        };
        option (google.api.method_signature) = "";
    }

    // ETF Quote Strategy 업데이트
    rpc UpdateEtfQuoteStrategy(UpdateEtfQuoteStrategyRequest) returns (EtfQuoteStrategy) {
        option (google.api.http) = {
            patch: "/v1/etfs/{strategy.symbol=*}/quote_strategy"
            body: "strategy"
        };
        option (google.api.method_signature) = "strategy,update_mask";
    }

    // ETF LP 상태 조회
    rpc GetEtfLpStatus(GetEtfLpStatusRequest) returns (EtfLpStatus) {
        option (google.api.http) = {
            get: "/v1/{etf=etfs/*}/lp/status"
        };
        option (google.api.method_signature) = "etf";
    }

    // ETF LP 상태 스트리밍 (실시간 업데이트)
    rpc StreamEtfLpStatus(StreamEtfLpStatusRequest) returns (stream EtfLpStatus) {
        option (google.api.http) = {
            get: "/v1/{etf=etfs/*}/lp/status:stream"
        };
        option (google.api.method_signature) = "etf,update_interval_seconds";
    }

    // ETF LP 시작
    rpc StartEtfLp(StartEtfLpRequest) returns (StartEtfLpResponse) {
        option (google.api.http) = {
            post: "/v1/{etf=etfs/*}/lp:start"
            body: "*"
        };
    }

    // ETF LP 중지
    rpc StopEtfLp(StopEtfLpRequest) returns (StopEtfLpResponse) {
        option (google.api.http) = {
            post: "/v1/{etf=etfs/*}/lp:stop"
            body: "*"
        };
    }

}


message Etf {
    // ETF ID
    uint64 id = 1;

    // ETF 심볼 (ISIN 코드)
    string symbol = 2;

    // ETF 이름
    string name = 3;

    // 마지막 가격
    string last_price = 4;

    // PDF 구성 종목 목록
    repeated EtfPdfConstituent constituents = 5;

    // NAV 정보
    EtfNav nav = 6;

    // Quote 전략
    EtfQuoteStrategy quote_strategy = 7;

    // 설정 단위
    int64 creation_unit = 8;

    // Tick 크기 (원 단위, i64)
    int64 tick_size = 9;

    // 복제 방법
    ReplicationMethod replication_method = 10;
}

// PDF 구성 종목
message EtfPdfConstituent {
    // 종목 코드
    string code = 1;

    // 종목명
    string name = 2;

    // 상품 타입
    ProductType product_type = 3;

    // 구성 수량 (선물 숏의 경우 음수)
    int64 quantity = 4;
}

// 상품 타입
enum ProductType {
    PRODUCT_TYPE_UNSPECIFIED = 0;
    PRODUCT_TYPE_STOCK = 1;
    PRODUCT_TYPE_FUTURES = 2;
    PRODUCT_TYPE_ETF = 3;
}

// ETF NAV 정보
message EtfNav {
    oneof nav_type {
        PhysicalNav physical = 1;
        FuturesBasedNav futures_based = 2;
    }
}

// 현물 기반 NAV
message PhysicalNav {
    // 마지막 NAV (원 단위, i64)
    string last_nav = 1;

    // 구성종목별 가격 정보
    map<string, ConstituentPrice> constituents = 2;
}

// 선물 기반 NAV
message FuturesBasedNav {
    // 마지막 NAV (원 단위, i64)
    string last_nav = 1;

    // 전일 NAV
    string prior_day_nav = 2;

    // 레버리지 배수
    double leverage_multiplier = 3;

    // 선물 심볼
    string futures_symbol = 4;

    // 선물 전일 가격
    string futures_prior_day_price = 5;

    // 선물 현재 가격
    string futures_last_price = 6;
}

// 구성종목 가격 정보
message ConstituentPrice {
    // 마지막 가격 (원 단위, i64)
    string last_price = 1;

    // 구성 수량
    int64 quantity = 2;
}

// ETF Quote 전략
message EtfQuoteStrategy {
    // ETF 심볼
    string symbol = 1;

    // Offset (호가 스프레드 조정, 원 단위, i64)
    int64 offset = 2;

    // Basis 스프레드 (원 단위, i64)
    int64 basis = 3;

    // 주문 수량 (i64)
    int64 quantity = 4;

    // 호가 깊이 (양방향 레벨 수)
    uint32 depth = 5;

    // ETF tick 크기 (원 단위, i64)
    int64 tick_size = 6;
}

// 복제 방법
enum ReplicationMethod {
    REPLICATION_METHOD_UNSPECIFIED = 0;
    REPLICATION_METHOD_PHYSICAL = 1;
    REPLICATION_METHOD_SYNTHETIC = 2;
    REPLICATION_METHOD_FUTURES_BASED = 3;
}

// ========== ETF LP Status Messages ==========

// ETF LP 상태
message EtfLpStatus {
    // LP 상태
    EtfLpState state = 1;

    // 시작 시간 (Unix timestamp, seconds)
    int64 start_time = 2;

    // 주문 통계
    OrderStats order_stats = 3;

    // Order Limiter 상태
    OrderLimitStatus order_limit = 4;

    // 가격 정보
    LpPricing pricing = 5;

    // Quote 전략
    EtfQuoteStrategy strategy = 6;
}

// ETF LP 상태 enum
enum EtfLpState {
    ETF_LP_STATE_UNSPECIFIED = 0;
    ETF_LP_STATE_IDLE = 1;
    ETF_LP_STATE_RUNNING = 2;
    ETF_LP_STATE_STOPPING = 3;
    ETF_LP_STATE_ERROR = 4;
}

// 주문 통계
message OrderStats {
    // 총 전송 주문 수
    uint64 total_orders_sent = 1;

    // 접수된 주문 수
    uint64 orders_accepted = 2;

    // 거부된 주문 수
    uint64 orders_rejected = 3;

    // 체결된 주문 수
    uint64 orders_filled = 4;

    // 총 체결 수량
    int64 total_filled_quantity = 5;

    // 일일 체결 수량
    int64 daily_filled_quantity = 6;
}

// Order Limiter 상태
message OrderLimitStatus {
    // 일일 누적 체결 수량 (i64)
    int64 daily_filled_quantity = 1;

    // 일일 누적 체결 수량 한도 (i64)
    int64 daily_cumulative_limit = 2;

    // 시간 프레임별 주문 개수 현황
    repeated TimeFrameStatus time_frame_status = 3;

    // 일일 사용률 (%)
    double daily_usage_percent = 4;
}

// 시간 프레임별 상태
message TimeFrameStatus {
    // 시간 윈도우 (초)
    uint64 window_seconds = 1;

    // 현재 윈도우 내 주문 개수
    uint32 current_count = 2;

    // 최대 주문 개수
    uint32 max_orders = 3;

    // 사용률 (%)
    double usage_percent = 4;
}

// LP 가격 정보
message LpPricing {
    // ETF 가격 (원 단위, i64)
    string etf_price = 1;

    // 선물 가격 (원 단위, i64)
    string future_price = 2;

    // ETF NAV (원 단위, i64)
    string etf_nav = 3;
}

// ========== Request/Response Messages ==========


message GetNFTRequest {
    // The resource name of the nft to retrieve.
    // Format: nfts/{chain_type}/{contract_address}/{token_id}
    // Examples: nfts/ETHEREUM/0x1f9090aaE28b8a3dCeaDf281B0F12828e676c326/1
    string nft = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "outpost.spacebarapis.xyz/NFT"
        }
    ];
}


// ListEtfs
message ListEtfsRequest {
    // 페이지 크기 (optional)
    optional uint32 page_size = 1;

    // 페이지 토큰 (optional, for pagination)
    optional string page_token = 2;
}

message ListEtfsResponse {
    // ETF 목록
    repeated Etf etfs = 1;

    // 다음 페이지 토큰
    string next_page_token = 2;
}

// GetEtf
message GetEtfRequest {
    string etf = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Etf"
        }
    ];
}

// GetEtfQuoteStrategy
message GetEtfQuoteStrategyRequest {
    string etf = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Etf"
        }
    ];
}


// UpdateEtfQuoteStrategy
message UpdateEtfQuoteStrategyRequest {
    // 새로운 Quote 전략
    EtfQuoteStrategy strategy = 1 [
        (google.api.field_behavior) = REQUIRED
    ];

    google.protobuf.FieldMask update_mask = 2;
}


// GetEtfLpStatus
message GetEtfLpStatusRequest {
    string etf = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Etf"
        }
    ];
}
// StreamEtfLpStatus
message StreamEtfLpStatusRequest {
    string etf = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Etf"
        }
    ];

    // 업데이트 간격 (초, optional, default: 1)
    optional uint32 update_interval_seconds = 2;
}

// ETF LP 시작 요청
message StartEtfLpRequest {
    string etf = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Etf"
        }
    ];
}

// ETF LP 시작 응답
message StartEtfLpResponse {
    // LP 상태
    EtfLpStatus status = 1;

    // 메시지
    string message = 2;
}

// ETF LP 중지 요청
message StopEtfLpRequest {
    // ETF 리소스 이름 (예: etfs/A069500)
    string etf = 1;
}

// ETF LP 중지 응답
message StopEtfLpResponse {
    // LP 상태
    EtfLpStatus status = 1;

    // 메시지
    string message = 2;
}