syntax = "proto3";

package kdo.v1.arbitrage;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/empty.proto";
import "google/api/resource.proto";
import "google/api/client.proto";
import "kdo/v1/basket.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1;kdo";

// ArbitrageService - 차익거래 관리 서비스
service ArbitrageService {
  // 단일 차익거래 조회
  rpc GetArbitrage(GetArbitrageRequest) returns (Arbitrage) {
    option (google.api.http) = {
      get: "/v1/{arbitrage=arbitrages/*}"
    };
    option (google.api.method_signature) = "arbitrage";
  }

  // 차익거래 목록 조회
  rpc ListArbitrages(ListArbitragesRequest) returns (ListArbitragesResponse) {
    option (google.api.http) = {
      get: "/v1/arbitrages"
    };
    option (google.api.method_signature) = "";
  }

  // 차익거래 생성
  rpc CreateArbitrage(CreateArbitrageRequest) returns (Arbitrage) {
    option (google.api.http) = {
      post: "/v1/arbitrages"
      body: "arbitrage"
    };
    option (google.api.method_signature) = "arbitrage";
  }

  // 차익거래 수정
  rpc UpdateArbitrage(UpdateArbitrageRequest) returns (Arbitrage) {
    option (google.api.http) = {
      patch: "/v1/{arbitrage.name=arbitrages/*}"
      body: "arbitrage"
    };
    option (google.api.method_signature) = "arbitrage,update_mask";
  }

  // 차익거래 삭제
  rpc DeleteArbitrage(DeleteArbitrageRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/v1/{arbitrage=arbitrages/*}"
    };
    option (google.api.method_signature) = "arbitrage";
  }

  // 차익거래 시작
  rpc StartArbitrage(StartArbitrageRequest) returns (ArbitrageStatus) {
    option (google.api.http) = {
      post: "/v1/{arbitrage=arbitrages/*}:start"
      body: "*"
    };
    option (google.api.method_signature) = "arbitrage";
  }

  // 차익거래 중지
  rpc StopArbitrage(StopArbitrageRequest) returns (ArbitrageStatus) {
    option (google.api.http) = {
      post: "/v1/{arbitrage=arbitrages/*}:stop"
      body: "*"
    };
    option (google.api.method_signature) = "arbitrage";
  }

  // 차익거래 상태 조회
  rpc GetArbitrageStatus(GetArbitrageStatusRequest) returns (ArbitrageStatus) {
    option (google.api.http) = {
      get: "/v1/{arbitrage=arbitrages/*}/status"
    };
    option (google.api.method_signature) = "arbitrage";
  }

  // 차익거래 상태 목록 조회
  rpc ListArbitrageStatuses(ListArbitrageStatusesRequest) returns (ListArbitrageStatusesResponse) {
    option (google.api.http) = {
      get: "/v1/arbitrages/status"
    };
    option (google.api.method_signature) = "";
  }

  // 차익거래 상태 스트리밍
  rpc StreamArbitrageStatus(StreamArbitrageStatusRequest) returns (stream ArbitrageStatusUpdate) {
    option (google.api.http) = {
      get: "/v1/{arbitrage=arbitrages/*}/status:stream"
    };
    option (google.api.method_signature) = "arbitrage";
  }

  // 차익거래 이벤트 스트리밍
  rpc StreamArbitrageEvents(StreamArbitrageEventsRequest) returns (stream ArbitrageEvent) {
    option (google.api.http) = {
      get: "/v1/{arbitrage=arbitrages/*}/events:stream"
    };
    option (google.api.method_signature) = "arbitrage";
  }
}

// ============================================================================
// Arbitrage Entity
// ============================================================================

// 차익거래 설정
message Arbitrage {
  option (google.api.resource) = {
    type: "kdo.cdsapis.xyz/Arbitrage"
    pattern: "arbitrages/{arbitrage}"
  };

  // 리소스 이름 (arbitrages/{id})
  string name = 1;

  // 차익거래 ID
  int32 id = 2 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // 소속 포트폴리오 ID
  int32 portfolio_id = 3;

  // 바스켓 A ID (Basket 도메인 참조)
  int32 basket_a_id = 5 [
    (google.api.field_behavior) = REQUIRED
  ];

  // 바스켓 B ID (Basket 도메인 참조)
  int32 basket_b_id = 6 [
    (google.api.field_behavior) = REQUIRED
  ];

  // 트리거 설정
  TriggerConfig trigger_config = 7;

  // 활성화 여부
  bool is_active = 9;

  // 생성 시간
  google.protobuf.Timestamp create_time = 10 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // 수정 시간
  google.protobuf.Timestamp update_time = 11 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // 바스켓 A 상세 (OUTPUT_ONLY, 조회 시 포함)
  kdo.v1.basket.Basket basket_a = 12 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // 바스켓 B 상세 (OUTPUT_ONLY, 조회 시 포함)
  kdo.v1.basket.Basket basket_b = 13 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];
}

// ============================================================================
// Trigger Configuration
// ============================================================================

// 트리거 설정
message TriggerConfig {
  // 트리거 조건
  TriggerCondition condition = 1;

  // 트리거 후 재트리거까지 대기시간 (ms)
  uint64 cooldown_ms = 2;
}

// 트리거 조건
message TriggerCondition {
  oneof condition {
    // 절대 스프레드 (금액)
    SpreadAmountCondition spread_amount = 1;
    // 상대 스프레드 (bps)
    SpreadBpsCondition spread_bps = 2;
  }
}

// 절대 스프레드 조건
message SpreadAmountCondition {
  // 스프레드 임계값 (원)
  int64 threshold = 1;
}

// 상대 스프레드 조건
message SpreadBpsCondition {
  // 스프레드 임계값 (bps, 1bp = 0.01%)
  double threshold_bps = 1;
}

// ============================================================================
// Status & Events
// ============================================================================

// 차익거래 상태
message ArbitrageStatus {
  // 리소스 이름 (arbitrages/{id})
  string name = 1;

  // 차익거래 ID
  int32 id = 2;

  // 현재 상태
  ArbitrageState state = 3;

  // 바스켓 A 현재 가치
  int64 basket_a_value = 4;

  // 바스켓 B 현재 가치
  int64 basket_b_value = 5;

  // 현재 스프레드
  int64 current_spread = 6;

  // 현재 스프레드 (bps)
  double current_spread_bps = 7;

  // 실행 상태 (실행 중일 때만)
  ExecutionState execution_state = 8;

  // 통계
  ArbitrageStats stats = 9;

  // 예상 실행 결과 (현재 호가 기준)
  ExecutionEstimate estimate = 10;
}

// 예상 실행 결과
message ExecutionEstimate {
  // A매수-B매도 시 예상 손익
  int64 buy_a_sell_b_pnl = 1;

  // B매수-A매도 시 예상 손익
  int64 buy_b_sell_a_pnl = 2;

  // 예상 슬리피지 (bps)
  double slippage_bps = 3;

  // 실행 가능 여부 (호가 수량 충분한지)
  bool executable = 4;

  // 실행 불가 사유 (executable=false인 경우)
  string reason = 5;
}

// 차익거래 런타임 상태
enum ArbitrageState {
  ARBITRAGE_STATE_UNSPECIFIED = 0;
  // 대기 중 (등록됨, 미시작)
  ARBITRAGE_STATE_IDLE = 1;
  // 모니터링 중 (시세 수신 및 트리거 평가)
  ARBITRAGE_STATE_MONITORING = 2;
  // 트리거 발동됨 (조건 충족, 실행 준비)
  ARBITRAGE_STATE_TRIGGERED = 3;
  // 실행 중 (주문 진행 중)
  ARBITRAGE_STATE_EXECUTING = 4;
  // 중지됨
  ARBITRAGE_STATE_STOPPED = 5;
  // 에러 상태
  ARBITRAGE_STATE_ERROR = 6;
}

// 실행 상태
message ExecutionState {
  // 실행 방향
  ArbitrageSide side = 1;

  // 현재 라운드 (1-based)
  uint32 current_round = 2;

  // 총 라운드 수
  uint32 total_rounds = 3;

  // 라운드별 체결 상태
  repeated RoundFillState round_fills = 4;

  // 전체 체결률
  double total_fill_rate = 5;

  // 트리거 시점 스프레드
  int64 trigger_spread = 6;
}

// 차익거래 방향
enum ArbitrageSide {
  ARBITRAGE_SIDE_UNSPECIFIED = 0;
  // A 매수, B 매도
  ARBITRAGE_SIDE_BUY_A_SELL_B = 1;
  // B 매수, A 매도
  ARBITRAGE_SIDE_BUY_B_SELL_A = 2;
}

// 라운드별 체결 상태
message RoundFillState {
  // 라운드 번호
  uint32 round = 1;

  // 심볼별 주문 수량
  map<string, int64> ordered_quantities = 2;

  // 심볼별 체결 수량
  map<string, int64> filled_quantities = 3;

  // 체결률
  double fill_rate = 4;
}

// 차익거래 통계
message ArbitrageStats {
  // 트리거 발동 횟수
  uint64 trigger_count = 1;

  // 실행 완료 횟수
  uint64 execution_count = 2;

  // 실행 실패 횟수
  uint64 execution_failures = 3;

  // 총 수익
  int64 total_profit = 4;
}

// 상태 업데이트 (스트리밍용)
message ArbitrageStatusUpdate {
  // 리소스 이름 (arbitrages/{id})
  string name = 1;

  // 차익거래 ID
  int32 id = 2;

  // 업데이트된 필드들
  google.protobuf.FieldMask update_mask = 3;

  // 상태 (필드마스크에 따라 부분 업데이트)
  ArbitrageStatus status = 4;

  // 바스켓 A 구성종목 가격 (include_basket_prices=true인 경우, 변경분만)
  repeated BasketItemPrice basket_a_prices = 5;

  // 바스켓 B 구성종목 가격 (include_basket_prices=true인 경우, 변경분만)
  repeated BasketItemPrice basket_b_prices = 6;
}

// 차익거래 이벤트
message ArbitrageEvent {
  // 리소스 이름 (arbitrages/{id})
  string name = 1;

  // 차익거래 ID
  int32 id = 2;

  // 이벤트 타입
  oneof event {
    StateChangedEvent state_changed = 3;
    PriceUpdateEvent price_update = 4;
    TriggeredEvent triggered = 5;
    RoundStartedEvent round_started = 6;
    OrderSubmittedEvent order_submitted = 7;
    OrderFilledEvent order_filled = 8;
    RoundCompletedEvent round_completed = 9;
    ExecutionCompletedEvent execution_completed = 10;
    ErrorEvent error = 11;
    BasketPriceUpdateEvent basket_price = 12;
  }
}

// 상태 변경 이벤트
message StateChangedEvent {
  ArbitrageState old_state = 1;
  ArbitrageState new_state = 2;
}

// 가격 업데이트 이벤트
message PriceUpdateEvent {
  int64 basket_a_value = 1;
  int64 basket_b_value = 2;
  int64 spread = 3;
  double spread_bps = 4;
}

// 트리거 발동 이벤트
message TriggeredEvent {
  ArbitrageSide side = 1;
  int64 spread = 2;
}

// 라운드 시작 이벤트
message RoundStartedEvent {
  uint32 round = 1;
  uint32 total_rounds = 2;
}

// 주문 제출 이벤트
message OrderSubmittedEvent {
  uint32 round = 1;
  string symbol = 2;
  int64 quantity = 3;
  int64 price = 4;
}

// 체결 이벤트
message OrderFilledEvent {
  uint32 round = 1;
  string symbol = 2;
  int64 filled_quantity = 3;
  int64 filled_price = 4;
}

// 라운드 완료 이벤트
message RoundCompletedEvent {
  uint32 round = 1;
  double fill_rate = 2;
}

// 실행 완료 이벤트
message ExecutionCompletedEvent {
  double total_fill_rate = 1;
}

// 에러 이벤트
message ErrorEvent {
  string message = 1;
}

// 바스켓 구분
enum BasketSide {
  BASKET_SIDE_UNSPECIFIED = 0;
  BASKET_SIDE_A = 1;
  BASKET_SIDE_B = 2;
}

// 바스켓 구성종목 가격 (개별 종목)
message BasketItemPrice {
  // 종목 심볼
  string symbol = 1;

  // 최우선 매수호가
  string bid1 = 2;

  // 최우선 매도호가
  string ask1 = 3;

  // 최우선 매수호가 수량
  int64 bid1_qty = 4;

  // 최우선 매도호가 수량
  int64 ask1_qty = 5;
}

// 바스켓 가격 업데이트 이벤트 (변경된 종목만 전송)
message BasketPriceUpdateEvent {
  // 어느 바스켓인지
  BasketSide side = 1;

  // 변경된 종목만 포함 (전체 아님)
  repeated BasketItemPrice updated_items = 2;
}

// ============================================================================
// Request/Response Messages
// ============================================================================

message GetArbitrageRequest {
  // 리소스 이름 (arbitrages/{id})
  string arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Arbitrage"
    }
  ];
}

message ListArbitragesRequest {
  // 페이지 크기 (optional)
  optional int32 page_size = 1;

  // 페이지 토큰 (optional, for pagination)
  optional string page_token = 2;

  // 필터링 조건 (optional, AIP-160)
  //
  // Available Fields:
  // * portfolio_id - 포트폴리오 ID
  // * is_active - 활성화 여부
  // * basket_a_id - 바스켓 A ID
  // * basket_b_id - 바스켓 B ID
  // * basket_a.basket_type - 바스켓 A 타입
  // * basket_b.basket_type - 바스켓 B 타입
  // * basket_a.etf_constituent.etf_symbol - 바스켓 A의 ETF 심볼
  // * basket_b.etf_constituent.etf_symbol - 바스켓 B의 ETF 심볼
  //
  // Operators:
  // * = : 일치
  // * != : 불일치
  //
  // Examples:
  // * portfolio_id=1
  // * is_active=true
  // * is_active=false
  // * basket_a_id=10
  // * portfolio_id=1 AND is_active=true
  // * basket_a.basket_type=BASKET_TYPE_ETF_CONSTITUENT
  // * basket_a.etf_constituent.etf_symbol="069500"
  // * basket_a.basket_type=BASKET_TYPE_ETF_CONSTITUENT AND basket_b.basket_type=BASKET_TYPE_REBALANCING
  string filter = 3 [(google.api.field_behavior) = OPTIONAL];
}

message ListArbitragesResponse {
  // 차익거래 목록
  repeated Arbitrage arbitrages = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}

message CreateArbitrageRequest {
  // 생성할 차익거래
  Arbitrage arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message UpdateArbitrageRequest {
  // 수정할 차익거래
  Arbitrage arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED
  ];

  // 수정할 필드 마스크
  google.protobuf.FieldMask update_mask = 2;
}

message DeleteArbitrageRequest {
  // 리소스 이름 (arbitrages/{id})
  string arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Arbitrage"
    }
  ];
}

message StartArbitrageRequest {
  // 리소스 이름 (arbitrages/{id})
  string arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Arbitrage"
    }
  ];
}

message StopArbitrageRequest {
  // 리소스 이름 (arbitrages/{id})
  string arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Arbitrage"
    }
  ];
}

message GetArbitrageStatusRequest {
  // 리소스 이름 (arbitrages/{id})
  string arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Arbitrage"
    }
  ];
}

message ListArbitrageStatusesRequest {
  // 페이지 크기 (optional)
  optional int32 page_size = 1;

  // 페이지 토큰 (optional, for pagination)
  optional string page_token = 2;

  // 필터링 조건 (optional, AIP-160)
  //
  // Available Fields:
  // * state - 상태 (ARBITRAGE_STATE_*)
  //
  // Examples:
  // * filter=state=ARBITRAGE_STATE_MONITORING
  string filter = 3 [(google.api.field_behavior) = OPTIONAL];
}

message ListArbitrageStatusesResponse {
  // 차익거래 상태 목록
  repeated ArbitrageStatus arbitrage_statuses = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}

message StreamArbitrageStatusRequest {
  // 리소스 이름 (arbitrages/{id})
  string arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Arbitrage"
    }
  ];

  // 구성종목 개별 가격 포함 여부 (기본: false)
  // true인 경우 ArbitrageStatusUpdate에 바스켓 구성종목 가격이 포함됨
  bool include_basket_prices = 2 [(google.api.field_behavior) = OPTIONAL];

  // 예상 손익/슬리피지 포함 여부 (기본: true)
  // ArbitrageStatus.estimate 필드 포함 여부
  bool include_estimate = 3 [(google.api.field_behavior) = OPTIONAL];
}

message StreamArbitrageEventsRequest {
  // 리소스 이름 (arbitrages/{id})
  string arbitrage = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Arbitrage"
    }
  ];

  // 바스켓 구성종목 가격 이벤트 포함 여부 (기본: false)
  // true인 경우 BasketPriceUpdateEvent가 스트림에 포함됨
  bool include_basket_prices = 2 [(google.api.field_behavior) = OPTIONAL];
}
