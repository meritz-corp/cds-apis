syntax = "proto3";

package kdo.v1.lp;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/api/resource.proto";
import "google/api/client.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1;kdo";

// LP 서비스는 ETF LP 관련 서비스를 제공합니다.
service LpService {
  // ETF LP 생성
//  rpc CreateEtfLp(CreateEtfLpRequest) returns (EtfLp) {
//    option (google.api.http) = {
//      post: "/v1/lps"
//      body: "etf_lp"
//    };
//    option (google.api.method_signature) = "etf_lp";
//  }

  // ETF LP 조회
  rpc GetEtfLp(GetEtfLpRequest) returns (EtfLp) {
    option (google.api.http) = {
      get: "/v1/lps/{etf=etfs/*}/{fund=funds/*}"
    };
    option (google.api.method_signature) = "";
  }

  // ETF LP 조회
  rpc ListEtfLps(ListEtfLpsRequest) returns (ListEtfLpsResponse) {
    option (google.api.http) = {
      get: "/v1/lps"
    };
    option (google.api.method_signature) = "";
  }

  // ETF LP 업데이트
  rpc UpdateEtfLp(UpdateEtfLpRequest) returns (EtfLp) {
    option (google.api.http) = {
      patch: "/v1/lps/etfs/{symbol=*}/funds/{fund_code=*}"
      body: "*"
    };
    option (google.api.method_signature) = "symbol,fund_code";
  }

  // ETF LP 상태 조회
  rpc GetEtfLpStatus(GetEtfLpStatusRequest) returns (EtfLpStatus) {
    option (google.api.http) = {
      get: "/v1/lps/{etf=etfs/*}/{fund=funds/*}/status"
    };
    option (google.api.method_signature) = "etf,fund";
  }

  // ETF LP 상태 조회
  rpc ListEtfLpStatuses(ListEtfLpStatusesRequest) returns (ListEtfLpStatusesResponse) {
    option (google.api.http) = {
      get: "/v1/lps/etfs/*/funds/*/status"
    };
    option (google.api.method_signature) = "";
  }


  // ETF LP 상태 스트리밍 (실시간 업데이트)
  rpc StreamEtfLpStatusUpdate(StreamEtfLpStatusUpdateRequest) returns (stream EtfLpStatusUpdate) {
    option (google.api.http) = {
      get: "/v1/lps/{etf=etfs/*}/{fund=funds/*}/status_update:stream"
    };
    option (google.api.method_signature) = "etf,fund,update_interval_seconds";
  }

  // ETF LP 시작
  rpc StartEtfLp(StartEtfLpRequest) returns (StartEtfLpResponse) {
    option (google.api.http) = {
      post: "/v1/lps/{etf=etfs/*}/{fund=funds/*}:start"
      body: "*"
    };
  }

  // ETF LP 중지
  rpc StopEtfLp(StopEtfLpRequest) returns (StopEtfLpResponse) {
    option (google.api.http) = {
      post: "/v1/lps/{etf=etfs/*}/{fund=funds/*}:stop"
      body: "*"
    };
  }

  // 사용자 주문장 업데이트를 가져오기
  rpc GetUserOrderbook(GetUserOrderBookRequest) returns (UserOrderbookData) {
    option (google.api.http) = {
      get: "/v1/lps/{etf=etfs/*}/{fund=funds/*}/orderbook"
    };
  }

  // 사용자 주문장 업데이트를 스트리밍
  rpc StreamUserOrderbook(GetUserOrderBookRequest) returns (stream UserOrderbookData) {
    option (google.api.http) = {
      get: "/v1/lps/{etf=etfs/*}/{fund=funds/*}/orderbook:stream"
    };
  }
}

// ETF LP 설정
message EtfLp {
  // ETF 심볼
  string symbol = 1;

  // Fund
  string fund_code = 2;

  // Basis 스프레드 (원 단위, i64)
  int64 basis = 6;

  // 주문 수량 (i64)
  int64 quantity = 7;

  // 호가 깊이 (양방향 레벨 수)
  uint32 depth = 8;

  // ETF tick 크기 (원 단위, i64)
  int64 tick_size = 9;

  // 동적 offset 조정 설정
  EtfLpOffset offset = 10;

  // 활성화 여부
  bool enabled = 11;

  // ETF 가격 산출 방식
  EtfPricing pricing_method = 12;
}

// ETF 가격 산출 방식
message EtfPricing {
  oneof method {
    // 분해 헷지 방식
    DecomposeHedgePricing decompose_hedge = 1;

    // 선물 헷지 방식
    UnderlyingFutureHedgePricing underlying_future_hedge = 2;
  }
}

// 분해 헷지 가격 산출 (추가 파라미터 없음)
message DecomposeHedgePricing {}

// 선물 헷지 가격 산출
message UnderlyingFutureHedgePricing {}

// ========== ETF LP Status Messages ==========

// ETF LP 상태
message EtfLpStatus {
  // ETF 심볼
  string etf_symbol = 1;

  // 펀드 코드
  string fund_code = 2;

  // Basis 스프레드 (원 단위, i64)
  int64 basis = 6;

  // 주문 수량 (i64)
  int64 quantity = 7;

  // LP 상태
  EtfLpState state = 8;

  // 가격 정보
  LpPricing pricing = 9;

  // 체결 통계
  FillStatistics fill_statistics = 10;

  // 동적 offset 조정 설정 (optional)
  EtfLpOffset offset = 11;

  // 헷지 정보
  EtfLpHedge hedge = 12;
}

// ETF LP 상태 업데이트 메시지 (변화된 필드만 포함)
message EtfLpStatusUpdate {
  // ETF 심볼
  string etf_symbol = 1;

  // 펀드 코드
  string fund_code = 2;

  // Basis 스프레드 (원 단위, i64)
  optional int64 basis = 6;

  // 주문 수량 (i64)
  optional int64 quantity = 7;

  // LP 상태
  optional EtfLpState state = 8;

  // 가격 정보
  optional LpPricing pricing = 9;

  // 체결 통계
  optional FillStatistics fill_statistics = 10;

  // 동적 offset 조정 설정 (optional)
  optional EtfLpOffset offset = 11;
}


// 순매매량 기반 조정 전략
enum PositionAdjustmentStrategy {
  POSITION_ADJUSTMENT_STRATEGY_UNSPECIFIED = 0;
  // 회피: 순매수 과다 시 매수offset 증가 (덜 공격적으로 매수)
  POSITION_ADJUSTMENT_STRATEGY_AVOIDANCE = 1;
  // 매매회전: 순매수 과다 시 매도offset 감소 (더 공격적으로 매도)
  POSITION_ADJUSTMENT_STRATEGY_TURNOVER = 2;
  // 모두 적용: 순매수 과다 시 매수offset 증가 및 매도offset 감소
  POSITION_ADJUSTMENT_STRATEGY_ALL = 10;
}

// 자동 offset 조정 설정
message EtfLpOffset {
  //
  double bid_offset = 1;
  double ask_offset = 2;

  // NAV 밴드 설정
  double min_offset = 3;
  double max_offset = 4;

  // 시간 기반 조정
  bool time_adjustment_enabled = 7;
  uint64 adjustment_interval_secs = 8;
  double adjustment_step = 9;
  bool reset_on_fill = 10;

  // 순매매량 기반 조정
  bool position_adjustment_enabled = 17;
  PositionAdjustmentStrategy position_strategy = 18;
  int64 position_threshold = 19;
  double position_adjustment_step = 20;
}

// ETF LP 헷지 설정
message EtfLpHedge {
  // 헷지 대상 종목 심볼
  string symbol = 1;

  // 펀드 리소스 이름
  // format: funds/{fund_code}
  string fund = 2 [
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];

  // 헷지 1주 주문당 ETF 체결수량 기준
  int64 filled_quantity_per_hedge = 3;
}


// ETF 체결 통계 (매수/매도 체결량 및 평균 단가)
message FillStatistics {
  // 매수 체결량
  int64 buy_filled_quantity = 1;

  // 매도 체결량
  int64 sell_filled_quantity = 2;

  // 매수 총금액 (평균 단가 계산용)
  string buy_total_amount = 3;

  // 매도 총금액 (평균 단가 계산용)
  string sell_total_amount = 4;
}

// ETF LP 상태 enum
enum EtfLpState {
  ETF_LP_STATE_UNSPECIFIED = 0;
  ETF_LP_STATE_IDLE = 1;
  ETF_LP_STATE_RUNNING = 2;
  ETF_LP_STATE_STOPPING = 3;
  ETF_LP_STATE_ERROR = 4;
}

// 주문 통계
message OrderStats {
  // 총 전송 주문 수
  uint64 total_orders_sent = 1;

  // 접수된 주문 수
  uint64 orders_accepted = 2;

  // 거부된 주문 수
  uint64 orders_rejected = 3;

  // 체결된 주문 수
  uint64 orders_filled = 4;

  // 총 체결 수량
  int64 total_filled_quantity = 5;

  // 일일 체결 수량
  int64 daily_filled_quantity = 6;
}

// Order Limiter 상태
//message OrderLimitStatus {
//  // 일일 누적 체결 수량 (i64)
//  int64 daily_filled_quantity = 1;
//
//  // 일일 누적 체결 수량 한도 (i64)
//  int64 daily_cumulative_limit = 2;
//
//  // 시간 프레임별 주문 개수 현황
//  repeated TimeFrameStatus time_frame_status = 3;
//
//  // 일일 사용률 (%)
//  double daily_usage_percent = 4;
//}

// 시간 프레임별 상태
message TimeFrameStatus {
  // 시간 윈도우 (초)
  uint64 window_seconds = 1;

  // 현재 윈도우 내 주문 개수
  uint32 current_count = 2;

  // 최대 주문 개수
  uint32 max_orders = 3;

  // 사용률 (%)
  double usage_percent = 4;
}

// LP 가격 정보
message LpPricing {
  // ETF NAV (원 단위)
  string etf_ask_nav = 3;

  string etf_bid_nav = 4;
}

// ========== Request/Response Messages ==========

// CreateEtfLp
message CreateEtfLpRequest {
  // 생성할 ETF LP 설정
  EtfLp etf_lp = 1 [(google.api.field_behavior) = REQUIRED];
}

// GetEtfLp
message GetEtfLpRequest {
  string etf = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Etf"
    }
  ];

  string fund = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}

// ListEtfLps
message ListEtfLpsRequest {
  // 페이지 크기 (optional)
  optional uint32 page_size = 1;

  // 페이지 토큰 (optional, for pagination)
  optional string page_token = 2;

  // Available Sequence and Operator
  // * etf_symbol
  //   * `equal`, `contains`
  // * fund_code
  //   * `equal`, `contains`
  //
  // Examples
  // * filter=etf_symbol:"005930"
  // * filter=fund_code="0159"
  string filter = 3;
}

message ListEtfLpsResponse {
  // ETF 목록
  repeated EtfLp etf_lps = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}

message ListEtfLpStatusesRequest {
  // 페이지 크기 (optional)
  optional uint32 page_size = 1;

  // 페이지 토큰 (optional, for pagination)
  optional string page_token = 2;

  // Available Sequence and Operator
  // * etf_symbol
  //   * `equal`, `contains`
  // * fund_code
  //   * `equal`, `contains`
  // * state
  //   * `equal`
  // * fill_satistics.buy_filled_quantity
  //   * `greater_than`, `less_than`
  //
  // Examples
  // * filter=etf_symbol:"005930"
  // * filter=fund_code="0159"
  // * filter=state=ETF_LP_STATE_RUNNING
  // * filter=fill_statistics.buy_filled_quantity > 1000

  string filter = 3 [(google.api.field_behavior) = OPTIONAL];

  // 오더링 조건. (optional, AIP-132)
  //
  // Supported Fields
  // * "fill_statistics.buy_filled_quantity", "fill_statistics.sell_filled_quantity"
  //
  // Examples
  // * order_by=fill_statistics.buy_filled_quantity desc
  string order_by = 5 [(google.api.field_behavior) = OPTIONAL];
}

message ListEtfLpStatusesResponse {
  // ETF 목록
  repeated EtfLpStatus etf_lp_statuses = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}


// UpdateEtfLp
message UpdateEtfLpRequest {
  // ETF 심볼
  string symbol = 1 [(google.api.field_behavior) = REQUIRED];

  // 펀드 코드
  string fund_code = 2 [(google.api.field_behavior) = REQUIRED];

  // 업데이트 대상
  oneof update {
    // 주문 수량
    int64 quantity = 3;

    // 호가 깊이
    uint32 depth = 4;

    // 동적 offset 조정 설정
    EtfLpOffset offset = 5;
  }
}


// GetEtfLpStatus
message GetEtfLpStatusRequest {
  string etf = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Etf"
    }
  ];

  string fund = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}
// StreamEtfLpStatus
message StreamEtfLpStatusUpdateRequest {
  string etf = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Etf"
    }
  ];

  string fund = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}

// ETF LP 시작 요청
message StartEtfLpRequest {
  string etf = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Etf"
    }
  ];

  string fund = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}

// ETF LP 시작 응답
message StartEtfLpResponse {
  // LP 상태
  EtfLpStatus status = 1;

  // 메시지
  string message = 2;
}

// ETF LP 중지 요청
message StopEtfLpRequest {
  string etf = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Etf"
    }
  ];

  string fund = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}

// ETF LP 중지 응답
message StopEtfLpResponse {
  // LP 상태
  EtfLpStatus status = 1;

  // 메시지
  string message = 2;
}

// StreamEtfErrors 요청
message StreamLpEventsRequest {
  string etf = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Etf"
    }
  ];

  string fund = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}

// 주문 업데이트 스트리밍 요청
message GetUserOrderBookRequest {
  string etf = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Etf"
    }
  ];

  string fund = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}

// 주문 업데이트 정보
message UserOrderbookData {
  // 매수 호가 (10단계, AIP-144)
  repeated string bid_prices = 1;

  // 매도 호가 (10단계)
  repeated string ask_prices = 2;

  // 매수 수량 (10단계)
  repeated int64 bid_quantities = 3;

  // 매도 수량 (10단계)
  repeated int64 ask_quantities = 4;
}