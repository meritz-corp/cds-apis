syntax = "proto3";

package kdo.v1.fund;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/api/client.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/empty.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1;kdo";

// FundService는 펀드 관련 서비스를 제공합니다.
service FundService {
  // 단일 펀드 조회
  rpc GetFund(GetFundRequest) returns (Fund) {
    option (google.api.http) = {
      get: "/v1/{fund=funds/*}"
    };
    option (google.api.method_signature) = "fund";
  }

  // 단일 펀드 스트림
  rpc StreamFund(GetFundRequest) returns (stream Fund) {
    option (google.api.http) = {
      get: "/v1/{fund=funds/*}:stream"
    };
    option (google.api.method_signature) = "fund";
  }

  // 펀드 목록 조회
  rpc ListFunds(ListFundsRequest) returns (ListFundsResponse) {
    option (google.api.http) = {
      get: "/v1/funds"
    };
    option (google.api.method_signature) = "";
  }

  rpc ListFundTradingSnapshots(ListFundTradingSnapshotsRequest) returns (ListFundTradingSnapshotsResponse) {
    option (google.api.http) = {
      get: "/v1/{fund=funds/*}/trading_snapshot"
    };
    option (google.api.method_signature) = "filter";
  }


  rpc StreamFundTradingSnapshots(ListFundTradingSnapshotsRequest) returns (stream ListFundTradingSnapshotsResponse) {
    option (google.api.http) = {
      get: "/v1/{fund=funds/*}/trading_snapshot:stream"
    };
    option (google.api.method_signature) = "filter";
  }

  rpc WatchLossLimitAlerts(WatchLossLimitAlertsRequest) returns (stream LossLimitAlert) {
    option (google.api.http) = {
      get: "/v1/{fund=funds/*}:watch-loss-limit-alerts"
    };
    option (google.api.method_signature) = "fund";
  }
}

// 펀드 정보
message Fund {
  // 펀드 코드 (표준 코드)
  string code = 1;
  // 펀드 이름
  string name = 2;
  // 펀드분류코드
  string category_code = 3;
  // 펀드관리직원번호
  string employee_number = 4;
  // 펀드관리직원성명
  string employee_name = 5;
  // 펀드 한도
  string limit_amount = 6;
  // 관리부서코드
  string department_code = 7;
  // 펀드거래구분코드
  string trade_code = 8;
  // 파트구분코드
  string part_code = 9;
  // 상품매매구분코드
  string part_name = 12;
  // 포지션합산여부
  string  product_deal_code = 13;
  // 파트구분명
  string  add_up_position = 14;
  // 트레이딩시스템종류코드
  string trading_system_code = 15;
  // 독립거래단위구분코드
  string unique_trading_unit_code = 16;
  // 독립거래단위파트구분코드
  string unique_trading_unit_part_code = 17;
  // 독립거래단위일련번호
  int64  unique_trading_unit_serial_number = 18;
  // 독립거래단위합산여부
  bool add_up_unique_trading_unit = 19;
  // 공매도ID
  string short_selling_id = 20;
}

message FundTrading {
  repeated FundLimit fund_limits = 1;  // 펀드 한도 목록
  FundPnL pnls = 2;          // 펀드 손익 목록
  FundExposure exposures = 3; // 펀드 익스포저 목록
  google.protobuf.Timestamp timestamp = 4; //

}

// 펀드 손익(PnL) 관리
message FundPnL {
  int64 daily_realized_pnl = 1;                 // 일일 손익
  int64 daily_unrealized_pnl = 2;                 // 일일 손익
  repeated SymbolPnL symbols = 3;  // 종목별 포지션 PnL 목록
}

// 종목별 포지션 PnL
message SymbolPnL {
  string symbol = 1;              // 종목 코드
  int64 quantity = 2;             // 보유 수량
  double average_entry_price = 3;   // 평균 진입가
  int64 current_price = 4;         // 현재가
  int64 unrealized_pnl = 5;       // 미실현 손익
  int64 realized_pnl = 6;         // 실현 손익
  int64 trading_cost = 7;         // 거래 비용
}

// 펀드 익스포저(Exposure) 관리
message FundExposure {
  int64 total_exposure = 1;                 // 전체 익스포저
  repeated SymbolExposure symbols = 2;  // 종목별 포지션 수량 목록
}

message SymbolExposure {
  string symbol = 1;              // 종목 코드
  int64 quantity = 2;             // 보유 수량
  int64 current_price = 3;         // 현재가
  int64 exposure = 4;         // 익스포저
}

message FundLimit {
  string fund = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];

  //
  FundLimitType limit_type = 2;

  // 매수한도수량
  int64 long_limit_quantity = 3;

  // 매수한도금액
  int64 long_limit_amount = 4;

  // 매도한도수량
  int64 short_limit_quantity = 5;

  // 매도한도금액
  int64 short_limit_amount = 6;

  // 1회 주문 한도계약수
  int64 limit_quantity_per_order = 7;

  // 1회 주문 한도금액
  int64 limit_amount_per_order = 8;

  // 1회 주문 한도틱
  int64 tick_limit = 9;

  // 미체결한도수량
  int64 unfilled_limit = 10;

  // 스프레드 1회 주문 한도계약수
  int64 spread_limit_quantity_per_order = 11;

  // 현재 누적 매수 수량
  int64 current_long_quantity = 12;

  // 현재 누적 매수 금액
  int64 current_long_amount = 13;

  // 현재 누적 매도 수량 (음수로 저장)
  int64 current_short_quantity = 14;

  // 현재 누적 매도 금액 (음수로 저장)
  int64 current_short_amount = 15;

  // 현재 미체결 수량
  int64 current_unfilled = 16;
}

enum FundLimitType {
  FUND_LIMIT_UNSPECIFIED = 0;
  KOSPI_200_Future = 1;
  STOCK = 2;
}

message LossLimitAlert {
  string fund_code = 1;
  int64 current_loss = 2;
  int64 loss_limit = 3;
  google.protobuf.Timestamp timestamp = 4;
  map<string, LossLimitSnapshot> snapshots = 5;
}

message LossLimitSnapshot {
  string symbol = 1;
  int64 quantity = 2;
  double average_price = 3;
  double current_price = 4;
  int64 unrealized_pnl = 5;
}

// ========== Request/Response Messages ==========

// GetFund 요청
message GetFundRequest {
  // 펀드 리소스 이름 (예: funds/KR1234567890)
  string fund = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}

// ListFunds 요청
message ListFundsRequest {
  // 페이지 크기 (optional)
  optional uint32 page_size = 1;

  // 페이지 토큰 (optional, for pagination)
  optional string page_token = 2;

  // Available Sequence and Operator
  // * fund_code
  //   * `equal`, `contains`
  // * employee_name
  //   * `equal`, `contains`
  //
  // Examples
  // * filter=fund_code="0159"
  // * filter=employee_name:"홍길동"
  string filter = 3;
}

// ListFunds 응답
message ListFundsResponse {
  // 펀드 목록
  repeated Fund funds = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}

message ListFundTradingSnapshotsRequest {
  // 펀드 리소스 이름 (예: funds/KR1234567890)
  string fund = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];

  // Available Sequence and Operator
  // * limit_type
  //   * `equal`
  //
  // Examples
  // * filter=limit_type=Stock
  string filter = 2;
}

message ListFundTradingSnapshotsResponse {
  // 펀드 한도 목록
  repeated FundTrading snapshots = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}

message WatchLossLimitAlertsRequest {
  // 펀드 리소스 이름 (예: funds/KR1234567890)
  string fund = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Fund"
    }
  ];
}
