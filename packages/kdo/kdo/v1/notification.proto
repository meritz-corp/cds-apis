syntax = "proto3";

package kdo.v1.notification;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/api/resource.proto";
import "google/api/client.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1/notifications;notifications";

// NotificationService provides notification management for users
service NotificationService {
  // ListNotifications returns a list of notifications for a user.
  rpc ListNotifications(ListNotificationsRequest) returns (ListNotificationsResponse) {
    option (google.api.http) = {
      get: "/v1/notifications"
    };
    option (google.api.method_signature) = "user";
  }

  // SubscribeNotifications subscribes to real-time notifications for a user.
  rpc SubscribeNotifications(SubscribeNotificationsRequest) returns (stream Notification) {
    option (google.api.http) = {
      get: "/v1/notifications:subscribe"
    };
    option (google.api.method_signature) = "user";
  }

  // AcknowledgeNotification marks a notification as acknowledged.
  rpc AcknowledgeNotification(AcknowledgeNotificationRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/{name=notifications/*}:ack"
      body: "*"
    };
    option (google.api.method_signature) = "name";
  }
}

// Request message for ListNotifications
message ListNotificationsRequest {
  // The resource name of User.
  // Format: users/{user_id}
  string user = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/User"
    }
  ];

  // The maximum number of items to return.
  // If unspecified, at most 50 rows will be returned.
  // The maximum value is 1024; values above 1024 will be coerced to 1024.
  int32 page_size = 2;

  // Token of the page to retrieve.
  string page_token = 3;

  // Filter expression.
  // Available filters:
  // * state: CREATED, ACKNOWLEDGED, EXPIRED
  // * type: INFO, ERROR
  //
  // Examples:
  // * state=CREATED
  // * type=INFO
  string filter = 4;
}

// Response message for ListNotifications
message ListNotificationsResponse {
  repeated Notification notifications = 1;
  string next_page_token = 2;
}

// Request message for SubscribeNotifications
message SubscribeNotificationsRequest {
  // The resource name of User.
  // Format: users/{user_id}
  string user = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/User"
    }
  ];

  // The resource name of Portfolio (optional, filter by portfolio).
  // Format: portfolios/{id}
  optional string portfolio = 2 [
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];
}

// Request message for AcknowledgeNotification
message AcknowledgeNotificationRequest {
  // The resource name of the notification.
  // Format: notifications/{notification_id}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Notification"
    }
  ];
}

// Type of the notification
enum NotificationType {
  TYPE_UNSPECIFIED = 0;
  // Informational notification
  INFO = 1;
  // Error notification
  ERROR = 2;
}

// State of the notification
enum NotificationState {
  STATE_UNSPECIFIED = 0;
  // Notification has been created
  CREATED = 1;
  // Notification has been acknowledged by user
  ACKNOWLEDGED = 2;
  // Notification has expired
  EXPIRED = 3;
}

// Action to perform when notification is clicked
message NotificationAction {
  // Type of action
  oneof action {
    // No operation
    NoOp no_op = 1;
    // Navigate to a page
    NavigateAction navigate = 2;
  }
}

// No operation action
message NoOp {}

// Navigation action
message NavigateAction {
  // Navigation target
  oneof target {
    // Navigate to LP page
    LpPageTarget lp_page = 1;
    // Future targets can be added here:
    // OrderDetailTarget order_detail = 2;
    // SettingsTarget settings = 3;
  }
}

// LP page navigation target
message LpPageTarget {
  // ETF code (e.g., "A252670")
  string etf_code = 1;

  // Fund code (e.g., "0331")
  string fund_code = 2;
}

// Notification resource
message Notification {
  option (google.api.resource) = {
    type: "kdo.cdsapis.xyz/Notification"
    pattern: "notifications/{notification_id}"
  };

  // The resource name of the Notification.
  // Format: notifications/{notification_id}
  string name = 1;

  // The resource name of User.
  // Format: users/{user_id}
  string user = 2 [
    (google.api.field_behavior) = OUTPUT_ONLY,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/User"
    }
  ];

  // The resource name of Portfolio (optional).
  // Format: portfolios/{id}
  optional string portfolio = 3 [
    (google.api.field_behavior) = OUTPUT_ONLY,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];

  // The id of Notification.
  uint64 id = 4 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Notification type
  NotificationType type = 5 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Action to perform when clicked
  NotificationAction action = 6 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Current state
  NotificationState state = 7 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Notification title
  string title = 8 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Notification body
  string body = 9 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Additional metadata
  map<string, string> metadata = 10 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Pre-computed navigation URL (convenience field)
  // e.g., "/lp/A252670"
  optional string navigation_url = 11 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Created timestamp
  google.protobuf.Timestamp create_time = 12 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Expiration timestamp (if applicable)
  optional google.protobuf.Timestamp expire_time = 13 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // Acknowledged timestamp
  optional google.protobuf.Timestamp acknowledge_time = 14 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];
}
