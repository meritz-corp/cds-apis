syntax = "proto3";

package kdo.v1.market;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/empty.proto";
import "google/api/resource.proto";
import "google/api/client.proto";

import "kdo/v1/etf.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1;kdo";

// 주문장 데이터를 스트리밍하는 서비스
service MarketService {
    // ETF 주문장 데이터를 스트리밍
    rpc StreamEtfOrderbook(StreamEtfOrderbookRequest) returns (stream EtfOrderbookData) {
        option (google.api.http) = {
            get: "/v1/market/{etf=etfs/*}/orderbook:stream"
        };
    }

    // 선물 주문장 데이터를 스트리밍
    rpc StreamFuturesOrderbook(StreamFuturesOrderbookRequest) returns (stream FuturesOrderbookData) {
        option (google.api.http) = {
            get: "/v1/market/{future=futures/*}/orderbook:stream"
        };
    }

    // ETF NAV 데이터를 스트리밍
    rpc StreamEtfNav(StreamEtfNavRequest) returns (stream EtfNav) {  // kdo.v1.etf.EtfNav
        option (google.api.http) = {
            get: "/v1/market/{etf=etfs/*}/nav:stream"
        };
    }

    // 사용자 주문장 업데이트를 가져오기
    rpc GetUserOrderbook(GetUserOrderBookRequest) returns (UserOrderbookData) {
        option (google.api.http) = {
            get: "/v1/market/{etf=etfs/*}/{fund=funds/*}/user-orderbook"
        };
    }

    // 사용자 주문장 업데이트를 스트리밍
    rpc StreamUserOrderbook(GetUserOrderBookRequest) returns (stream UserOrderbookData) {
        option (google.api.http) = {
            get: "/v1/market/{etf=etfs/*}/{fund=funds/*}/user-orderbook:stream"
        };
    }

    // 새로운 Raw 메시지 스트리밍 UDP 소켓 추가
    rpc AddRawMessagesSocket(AddRawMessagesSocketRequest) returns (AddRawMessagesSocketResponse) {
        option (google.api.http) = {
            post: "/v1/market/raw-messages/sockets"
            body: "*"
        };
    }

    // Raw 메시지 스트리밍 (server-side streaming)
    rpc StreamRawMessages(StreamRawMessagesRequest) returns (stream RawMarketMessage) {
        option (google.api.http) = {
            get: "/v1/market/raw-messages:stream"
        };
    }

    // 마켓 세션 정보 조회
    rpc GetMarketSession(google.protobuf.Empty) returns (GetMarketSessionResponse) {
        option (google.api.http) = {
            get: "/v1/market/session"
        };
    }

}

// 세션 ID 열거형 (AIP-126)
enum SessionId {
    SESSION_ID_UNSPECIFIED = 0; // 기본값
    PREVIOUS = 1;               // 장개시전
    CONNECTED = 2;              // 연결됨
    OPENING_ONE_PRICE = 3;      // 시가단일가
    ONE_PRICE = 4;              // 단일가
    CLOSING_ONE_PRICE = 5;      // 종가단일가
    VI_ONE_PRICE = 6;           // VI장중단일가
    VI_OPENING_ONE_PRICE = 7;   // VI시가단일가
    VI_CLOSING_ONE_PRICE = 8;   // VI종가단일가
    UNIT_TRADE = 9;             // 단위매매
    POST_MARKET = 10;           // 장종료후호가접수
    AUCTION_BID = 11;           // 경매매수호가 접수 세션
    AUCTION_ASK = 12;           // 경매매도호가 접수 세션
    SUSPENDED = 13;             // 거래정지
    SHUTDOWN = 14;              // 셧다운
    CLOSED = 15;                // 장마감
    ETC = 16;                   // 기타
}

// ETF 주문장 데이터
message EtfOrderbookData {
    // 매수 호가 (10단계, AIP-144)
    repeated string bid_prices = 1;

    // 매도 호가 (10단계)
    repeated string ask_prices = 2;

    // 매수 수량 (10단계)
    repeated int64 bid_quantities = 3;

    // 매도 수량 (10단계)
    repeated int64 ask_quantities = 4;

    // LP 매수 수량 (10단계)
    repeated int64 lp_bid_quantities = 5;

    // LP 매도 수량 (10단계)
    repeated int64 lp_ask_quantities = 6;

    // 중간 호가
    string mid_price = 7;

    // 중간 매도 수량
    int64 mid_ask_quantity = 8;

    // 중간 매수 수량
    int64 mid_bid_quantity = 9;

    // 총 매도 호가 수량
    int64 ask_quote_total_quantity = 10;

    // 총 매수 호가 수량
    int64 bid_quote_total_quantity = 11;

    // 예상 가격
    string est_price = 12;

    // 예상 거래량
    int64 est_volume = 13;

    // 세션 ID
    SessionId session_id = 14;
}

// 선물 주문장 데이터
message FuturesOrderbookData {
    // 매수 호가 (5단계, AIP-144)
    repeated string bid_prices = 1;

    // 매도 호가 (5단계)
    repeated string ask_prices = 2;

    // 매수 수량 (5단계)
    repeated int64 bid_quantities = 3;

    // 매도 수량 (5단계)
    repeated int64 ask_quantities = 4;

    // 매수 주문 수 (5단계)
    repeated int64 bid_counts = 5;

    // 매도 주문 수 (5단계)
    repeated int64 ask_counts = 6;

    // 총 매도 호가 수량
    int64 ask_quote_total_quantity = 7;

    // 총 매수 호가 수량
    int64 bid_quote_total_quantity = 8;

    // 중간 가격
    string mid_price = 9;

    // 예상 가격
    string est_price = 10;

    // 예상 거래량
    int64 est_volume = 11;

    // 세션 ID
    SessionId session_id = 12;
}

message EtfNav {
    string name = 1;

    string etf_symbol = 2;

    // 순자산가치 (원 단위, string)
    string theory_nav = 10;

    // 전일 대비 (string)
    string krx_nav = 11;
}

// ========== Request/Response Messages ==========

// ETF 주문장 스트리밍 요청
message StreamEtfOrderbookRequest {
    string etf = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Etf"
        }
    ];
}

// 선물 주문장 스트리밍 요청
message StreamFuturesOrderbookRequest {
    // 리소스 이름 (예: futures/K101W9000)
    string future = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Future"
        }
    ];
}

message StreamEtfNavRequest {
    string etf = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Etf"
        }
    ];
}

// 주문 업데이트 스트리밍 요청
message GetUserOrderBookRequest {
    string etf = 1 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Etf"
        }
    ];

    string fund = 2 [
        (google.api.field_behavior) = REQUIRED,
        (google.api.resource_reference) = {
            type: "kdo.cdsapis.xyz/Fund"
        }
    ];
}

// 주문 업데이트 정보
message UserOrderbookData {
    // 매수 호가 (10단계, AIP-144)
    repeated string bid_prices = 1;

    // 매도 호가 (10단계)
    repeated string ask_prices = 2;

    // 매수 수량 (10단계)
    repeated int64 bid_quantities = 3;

    // 매도 수량 (10단계)
    repeated int64 ask_quantities = 4;

    // 주문 ID (10단계)
    repeated int64 order_ids = 5;
}

// Request to add a new raw UDP socket
message AddRawMessagesSocketRequest {
    // Multicast address to listen on (e.g., "239.1.1.1")
    string multicast_address = 1;

    // Interface address to bind (e.g., "192.168.1.100")
    string multicast_interface = 2;

    // UDP port to listen on
    uint32 port = 3;

    // Buffer size for receiving UDP packets (default: 2048)
    uint32 buffer_size = 4;
}

// Response from adding a raw socket
message AddRawMessagesSocketResponse {
    // Whether the socket was added successfully
    bool success = 1;

    // Error message if success is false
    string error_message = 2;
}

// Request to stream raw market messages
message StreamRawMessagesRequest {
    // Optional filter by socket IDs (empty = all sockets)
    repeated string socket_ids = 1;

    // Optional buffer size for the stream (default: 100)
    uint32 buffer_size = 2;
}

// Raw market message received from UDP socket
message RawMarketMessage {
    // Raw binary data received from the socket
    bytes data = 1;

    // Timestamp when the message was received (nanoseconds since epoch)
    int64 receive_timestamp_ns = 2;

    // Message sequence number (per socket)
    uint64 sequence_number = 3;
}


message GetMarketSessionResponse {
  MarketSession session = 1;
}

enum MarketSession {
  MARKT_SESSION_UNSPECIFIED = 0;
  MARKT_SESSION_PRE_MARKET = 1;       // 장 시작 전
  MARKT_SESSION_OPENING_AUCTION = 2;  // 시가 동시호가 (08:30 ~ 09:00)
  MARKT_SESSION_REGULAR = 3;          // 장중 (09:00 ~ 15:20)
  MARKT_SESSION_CLOSING_AUCTION = 4;  // 종가 동시호가 (15:20 ~ 15:30)
  MARKT_SESSION_CLOSED = 5;           // 장 종료
}