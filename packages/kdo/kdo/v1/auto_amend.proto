syntax = "proto3";

package kdo.v1.auto_amend;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/empty.proto";
import "google/api/resource.proto";
import "google/api/client.proto";
import "kdo/v1/common.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1;kdo";

// AutoAmendService - 자동 정정 서비스
//
// 주문의 자동 정정을 관리합니다.
// - 장중: 상대호가 잔량 비율 기반 정정
// - 동시호가: 예체가 관여 방지 (가격 ±1%, 수량 30% 제한)
service AutoAmendService {
  // 등록된 주문 조회
  rpc GetOrder(GetAutoAmendOrderRequest) returns (AutoAmendOrder) {
    option (google.api.http) = {
      get: "/v1/auto-amend/orders/{order_id}"
    };
    option (google.api.method_signature) = "order_id";
  }

  // 등록된 주문 목록 조회
  rpc ListOrders(ListAutoAmendOrdersRequest) returns (ListAutoAmendOrdersResponse) {
    option (google.api.http) = {
      get: "/v1/auto-amend/orders"
    };
    option (google.api.method_signature) = "";
  }

  // 설정 업데이트
  rpc UpdateConfig(UpdateConfigRequest) returns (AutoAmendOrder) {
    option (google.api.http) = {
      patch: "/v1/auto-amend/orders/{order_id}/config"
      body: "config"
    };
    option (google.api.method_signature) = "order_id,config";
  }

  // 이벤트 스트리밍
  rpc StreamEvents(StreamEventsRequest) returns (stream AutoAmendEvent) {
    option (google.api.http) = {
      get: "/v1/auto-amend/events:stream"
    };
    option (google.api.method_signature) = "";
  }
}

// ============================================================================
// Entities
// ============================================================================

// 자동정정 등록 주문
message AutoAmendOrder {
  // 주문 ID
  uint64 order_id = 1;

  // 종목 심볼
  string symbol = 2;

  // 주문 방향
  kdo.v1.common.OrderSide side = 3;

  // 현재 주문 가격
  string price = 4;

  // 현재 주문 수량
  int64 quantity = 5;

  // 미체결 수량
  int64 remaining_quantity = 6;

  // 자동정정 설정
  AmendConfig config = 7;

  // 정정 횟수
  uint32 amend_count = 8 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // 마지막 정정 시각 (unix timestamp ms)
  int64 last_amend_time_ms = 9 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];

  // 활성화 여부
  bool is_active = 10 [
    (google.api.field_behavior) = OUTPUT_ONLY
  ];
}

// ============================================================================
// Configuration
// ============================================================================

// 자동정정 설정
message AmendConfig {
  // 장중 정정 설정
  RegularSessionConfig regular_session = 1;

  // 동시호가 정정 설정
  AuctionSessionConfig auction_session = 2;
}

// 장중 자동정정 설정
message RegularSessionConfig {
  // 활성화 여부
  bool enabled = 1;

  // 상대호가 잔량 비율 임계값 (0.0 ~ 1.0)
  // 매수: 매도1호가잔량 / 매수1호가잔량 < threshold → 매도1호가로 정정
  // 매도: 매수1호가잔량 / 매도1호가잔량 < threshold → 매수1호가로 정정
  double opposite_qty_ratio_threshold = 2;
}

// 동시호가 정정 설정 (예체가 관여 방지)
message AuctionSessionConfig {
  // 활성화 여부
  bool enabled = 1;

  // 예상체결가 대비 허용 가격 범위 (0.0 ~ 1.0, e.g., 0.01 = ±1%)
  double price_limit_pct = 2;

  // 예상체결수량 대비 최대 수량 비율 (0.0 ~ 1.0, e.g., 0.30 = 30%)
  double quantity_limit_pct = 3;
}

// ============================================================================
// Session Info
// ============================================================================

// ============================================================================
// Service Status
// ============================================================================

// 서비스 상태
message ServiceStatus {
  // 서비스 실행 중 여부
  bool is_running = 1;

  // 현재 세션
  kdo.v1.common.TradingSession current_session = 2;

  // 활성 주문 수
  uint32 active_order_count = 3;

  // 총 등록 주문 수
  uint32 total_order_count = 4;
}

// ============================================================================
// Events
// ============================================================================

// 자동정정 이벤트
message AutoAmendEvent {
  oneof event {
    AmendedEvent amended = 1;
    AmendFailedEvent amend_failed = 2;
    SessionChangedEvent session_changed = 3;
    OrderRegisteredEvent order_registered = 4;
    OrderUnregisteredEvent order_unregistered = 5;
  }
}

// 정정 실행 이벤트
message AmendedEvent {
  // 주문 ID
  uint64 order_id = 1;

  // 종목 심볼
  string symbol = 2;

  // 정정 액션
  AmendAction action = 3;

  // 이전 가격
  int64 old_price = 4;

  // 새 가격
  int64 new_price = 5;

  // 이전 수량
  int64 old_quantity = 6;

  // 새 수량
  int64 new_quantity = 7;

  // 정정 사유
  string reason = 8;
}

// 정정 액션 타입
enum AmendAction {
  AMEND_ACTION_UNSPECIFIED = 0;
  AMEND_ACTION_CHANGE_PRICE = 1;              // 가격 정정
  AMEND_ACTION_CHANGE_QUANTITY = 2;           // 수량 정정
  AMEND_ACTION_CHANGE_PRICE_AND_QUANTITY = 3; // 가격+수량 정정
}

// 정정 실패 이벤트
message AmendFailedEvent {
  // 주문 ID
  uint64 order_id = 1;

  // 종목 심볼
  string symbol = 2;

  // 실패 사유
  string reason = 3;
}

// 세션 변경 이벤트
message SessionChangedEvent {
  // 이전 세션
  kdo.v1.common.TradingSession old_session = 1;

  // 새 세션
  kdo.v1.common.TradingSession new_session = 2;
}

// 주문 등록 이벤트
message OrderRegisteredEvent {
  // 주문 ID
  uint64 order_id = 1;

  // 종목 심볼
  string symbol = 2;

  // 주문 방향
  kdo.v1.common.OrderSide side = 3;
}

// 주문 해제 이벤트
message OrderUnregisteredEvent {
  // 주문 ID
  uint64 order_id = 1;

  // 해제 사유
  string reason = 2;
}

// ============================================================================
// Request/Response Messages
// ============================================================================

message GetAutoAmendOrderRequest {
  // 주문 ID
  uint64 order_id = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message ListAutoAmendOrdersRequest {
  // 종목 필터 (optional)
  string symbol = 1 [
    (google.api.field_behavior) = OPTIONAL
  ];

  // 주문 방향 필터 (optional)
  kdo.v1.common.OrderSide side = 2 [
    (google.api.field_behavior) = OPTIONAL
  ];

  // 활성화된 주문만 (optional, 기본: true)
  bool active_only = 3 [
    (google.api.field_behavior) = OPTIONAL
  ];
}

message ListAutoAmendOrdersResponse {
  // 등록된 주문 목록
  repeated AutoAmendOrder orders = 1;
}

message UpdateConfigRequest {
  // 주문 ID
  uint64 order_id = 1 [
    (google.api.field_behavior) = REQUIRED
  ];

  // 새 설정
  AmendConfig config = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message StreamEventsRequest {
  // 특정 주문 ID 필터 (optional, 미지정 시 전체)
  repeated uint64 order_ids = 1 [
    (google.api.field_behavior) = OPTIONAL
  ];
}
