syntax = "proto3";

package kdo.v1.portfolio;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/api/client.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/empty.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1;kdo";

// PortfolioService는 포트폴리오 관련 서비스를 제공합니다.
// Portfolio는 P&L(손익) 집계 단위입니다.
// 계층 구조: Portfolio (1) → HedgeGroup (N) → Fund (N)
service PortfolioService {
  // 단일 포트폴리오 조회
  rpc GetPortfolio(GetPortfolioRequest) returns (Portfolio) {
    option (google.api.http) = {
      get: "/v1/{name=portfolios/*}"
    };
    option (google.api.method_signature) = "name";
  }

  // 포트폴리오 목록 조회
  rpc ListPortfolios(ListPortfoliosRequest) returns (ListPortfoliosResponse) {
    option (google.api.http) = {
      get: "/v1/portfolios"
    };
    option (google.api.method_signature) = "";
  }

  // 포트폴리오 생성
//  rpc CreatePortfolio(CreatePortfolioRequest) returns (Portfolio) {
//    option (google.api.http) = {
//      post: "/v1/portfolios"
//      body: "portfolio"
//    };
//    option (google.api.method_signature) = "portfolio";
//  }

  // 포트폴리오 수정
  rpc UpdatePortfolio(UpdatePortfolioRequest) returns (Portfolio) {
    option (google.api.http) = {
      patch: "/v1/{portfolio.name=portfolios/*}"
      body: "portfolio"
    };
    option (google.api.method_signature) = "portfolio,update_mask";
  }

  // 포트폴리오 삭제
//  rpc DeletePortfolio(DeletePortfolioRequest) returns (google.protobuf.Empty) {
//    option (google.api.http) = {
//      delete: "/v1/{name=portfolios/*}"
//    };
//    option (google.api.method_signature) = "name";
//  }

  // 포트폴리오 P&L 조회
  // 포트폴리오 하위 모든 HedgeGroup → Fund의 손익을 집계합니다.
  rpc GetPortfolioPnL(GetPortfolioPnLRequest) returns (PortfolioPnL) {
    option (google.api.http) = {
      get: "/v1/{name=portfolios/*}/pnl"
    };
    option (google.api.method_signature) = "name";
  }

  // 포트폴리오 P&L 스트림
  rpc StreamPortfolioPnL(GetPortfolioPnLRequest) returns (stream PortfolioPnL) {
    option (google.api.http) = {
      get: "/v1/{name=portfolios/*}/pnl:stream"
    };
    option (google.api.method_signature) = "name";
  }

  // 포트폴리오 Exposure 조회
  rpc GetPortfolioExposure(GetPortfolioExposureRequest) returns (PortfolioExposure) {
    option (google.api.http) = {
      get: "/v1/{name=portfolios/*}/exposure"
    };
    option (google.api.method_signature) = "name";
  }

  // 포트폴리오 Exposure 스트림
  rpc StreamPortfolioExposure(GetPortfolioExposureRequest) returns (stream PortfolioExposure) {
    option (google.api.http) = {
      get: "/v1/{name=portfolios/*}/exposure:stream"
    };
    option (google.api.method_signature) = "name";
  }

  // 포트폴리오에 속한 HedgeGroup 목록 조회
  rpc ListPortfolioHedgeGroups(ListPortfolioHedgeGroupsRequest) returns (ListPortfolioHedgeGroupsResponse) {
    option (google.api.http) = {
      get: "/v1/{parent=portfolios/*}/hedge_groups"
    };
    option (google.api.method_signature) = "parent";
  }

  // 포트폴리오에 속한 Fund 목록 조회
  // (Portfolio → HedgeGroups → Funds)
  rpc ListPortfolioFunds(ListPortfolioFundsRequest) returns (ListPortfolioFundsResponse) {
    option (google.api.http) = {
      get: "/v1/{parent=portfolios/*}/funds"
    };
    option (google.api.method_signature) = "parent";
  }
}

// ========== Resource Messages ==========

// 포트폴리오 정보
// P&L(손익) 집계 단위
message Portfolio {
  option (google.api.resource) = {
    type: "kdo.cdsapis.xyz/Portfolio"
    pattern: "portfolios/{portfolio}"
  };

  // 포트폴리오 리소스 이름 (예: portfolios/1)
  string name = 1 [(google.api.field_behavior) = OUTPUT_ONLY];

  // 포트폴리오 ID
  int32 id = 2 [(google.api.field_behavior) = OUTPUT_ONLY];

  // 포트폴리오 이름 (고유)
  string display_name = 3 [(google.api.field_behavior) = REQUIRED];

  // 포트폴리오 설명
  string description = 4;

  // 활성화 여부
  bool is_active = 5;

  // 생성 시간
  google.protobuf.Timestamp create_time = 6 [(google.api.field_behavior) = OUTPUT_ONLY];

  // 수정 시간
  google.protobuf.Timestamp update_time = 7 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// 포트폴리오 P&L 집계 결과
message PortfolioPnL {
  // 포트폴리오 리소스 이름
  string portfolio = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];

  // 포트폴리오 ID
  int32 portfolio_id = 2;

  // 포트폴리오 이름
  string portfolio_name = 3;

  // 실현 손익 (원)
  int64 realized_pnl = 4;

  // 미실현 손익 (원)
  int64 unrealized_pnl = 5;

  // 거래 비용 (원)
  int64 trading_cost = 6;

  // 순손익 (realized + unrealized - trading_cost)
  int64 net_pnl = 7;

  // 하위 펀드 수
  int32 fund_count = 8;

  // 하위 헷지그룹 수
  int32 hedge_group_count = 9;

  // 종목별 P&L 상세
  repeated SymbolPnLDetail symbol_pnls = 10;

  // 스냅샷 시간
  google.protobuf.Timestamp timestamp = 11;
}

// 종목별 P&L 상세
message SymbolPnLDetail {
  // 종목 코드
  string symbol = 1;

  // 보유 수량
  double quantity = 2;

  // 평균 진입가
  double average_entry_price = 3;

  // 현재가
  double current_price = 4;

  // 미실현 손익
  int64 unrealized_pnl = 5;

  // 실현 손익
  int64 realized_pnl = 6;

  // 거래 비용
  int64 trading_cost = 7;
}

// 포트폴리오 Exposure (실시간 포지션 및 손익 추적)
message PortfolioExposure {
  // 포트폴리오 리소스 이름
  string portfolio = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];

  // 포트폴리오 ID
  int32 portfolio_id = 2;

  // 심볼별 통합 포지션 (모든 Fund 합산)
  repeated SymbolPosition positions = 3;

  // Fund별 심볼 포지션 (상세 추적용)
  repeated FundSymbolPosition fund_positions = 4;

  // 실현 손익 (당일)
  int64 realized_pnl = 5;

  // 미실현 손익 (현재가 기준)
  int64 unrealized_pnl = 6;

  // 거래 비용 (수수료 등)
  int64 trading_cost = 7;

  // 순손익 (realized + unrealized - trading_cost)
  int64 net_pnl = 8;

  // 전체 net exposure 수량
  int64 total_net_quantity = 9;

  // 전체 exposure 금액
  int64 total_exposure_amount = 10;

  // Net Exposures (Hedge 변환 후 상계된 결과)
  // positions를 nettings 설정에 따라 분해/변환한 결과
  NetExposures net_exposures = 11;

  // 마지막 업데이트 시간
  google.protobuf.Timestamp last_update = 15;
}

// 심볼별 통합 포지션
message SymbolPosition {
  // 종목 심볼
  string symbol = 1;

  // 순수량 (long - short, 모든 Fund 합산)
  int64 net_quantity = 2;

  // 평균 매입 단가
  double average_cost = 3;

  // 현재가
  double current_price = 4;

  // 미실현 손익
  int64 unrealized_pnl = 5;

  // 익스포저 금액 (net_quantity * current_price)
  int64 exposure_amount = 6;
}

// Fund별 심볼 포지션 (상세)
message FundSymbolPosition {
  // 펀드 코드
  string fund_code = 1;

  // 종목 심볼
  string symbol = 2;

  // 수량
  int64 quantity = 3;

  // 평균 매입 단가
  double average_cost = 4;

  // 현재가
  double current_price = 5;

  // 미실현 손익
  int64 unrealized_pnl = 6;
}

// Net Exposures 집계 구조체 (Hedge 변환 후 상계된 결과)
message NetExposures {
  // 심볼별 Net Exposure
  repeated NetExposure exposures = 1;

  // 전체 수량 합계
  float total_quantity = 2;

  // 전체 익스포저 금액
  int64 total_exposure = 3;
}

// Net Exposure (변환된 포지션)
message NetExposure {
  // 종목 심볼
  string symbol = 1;

  // 누적 수량 (분해 후 합산, 소수점 2자리)
  double net_quantity = 2;

  // 현재가
  double current_price = 3;

  // 익스포저 금액 (net_quantity * current_price)
  int64 exposure_amount = 4;
}

// HedgeGroup 요약 정보 (포트폴리오 컨텍스트)
message HedgeGroupSummary {
  // 헷지그룹 ID
  int32 id = 1;

  // 헷지그룹 이름
  string name = 2;

  // 헷지 방식
  string hedge_method = 3;

  // 트리거 조건
  string trigger_condition = 4;

  // 하위 펀드 수
  int32 fund_count = 5;

  // 활성화 여부
  bool is_active = 6;
}

// Fund 요약 정보 (포트폴리오 컨텍스트)
message FundSummary {
  // 펀드 코드
  string code = 1;

  // 펀드 이름
  string name = 2;

  // 속한 헷지그룹 ID
  int32 hedge_group_id = 3;

  // 속한 헷지그룹 이름
  string hedge_group_name = 4;
}

// ========== Request/Response Messages ==========

// GetPortfolio 요청
message GetPortfolioRequest {
  // 포트폴리오 리소스 이름 (예: portfolios/1)
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];
}

// ListPortfolios 요청
message ListPortfoliosRequest {
  // 페이지 크기 (optional)
  optional int32 page_size = 1;

  // 페이지 토큰 (optional, for pagination)
  optional string page_token = 2;

  // 필터
  // Available filters:
  // * is_active
  //   * `equal` (true/false)
  // * display_name
  //   * `equal`, `contains`
  //
  // Examples:
  // * filter=is_active=true
  // * filter=display_name:"ELS"
  string filter = 3;
}

// ListPortfolios 응답
message ListPortfoliosResponse {
  // 포트폴리오 목록
  repeated Portfolio portfolios = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}

// CreatePortfolio 요청
message CreatePortfolioRequest {
  // 생성할 포트폴리오 정보
  Portfolio portfolio = 1 [(google.api.field_behavior) = REQUIRED];
}

// UpdatePortfolio 요청
message UpdatePortfolioRequest {
  // 수정할 포트폴리오 정보
  Portfolio portfolio = 1 [(google.api.field_behavior) = REQUIRED];

  // 수정할 필드 마스크
  google.protobuf.FieldMask update_mask = 2;
}

// DeletePortfolio 요청
message DeletePortfolioRequest {
  // 삭제할 포트폴리오 리소스 이름
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];
}

// GetPortfolioPnL 요청
message GetPortfolioPnLRequest {
  // 포트폴리오 리소스 이름
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];
}

// GetPortfolioExposure 요청
message GetPortfolioExposureRequest {
  // 포트폴리오 리소스 이름 (예: portfolios/1)
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];
}

// ListPortfolioHedgeGroups 요청
message ListPortfolioHedgeGroupsRequest {
  // 부모 포트폴리오 리소스 이름
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];

  // 페이지 크기 (optional)
  optional int32 page_size = 2;

  // 페이지 토큰 (optional)
  optional string page_token = 3;
}

// ListPortfolioHedgeGroups 응답
message ListPortfolioHedgeGroupsResponse {
  // 헷지그룹 목록
  repeated HedgeGroupSummary hedge_groups = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}

// ListPortfolioFunds 요청
message ListPortfolioFundsRequest {
  // 부모 포트폴리오 리소스 이름
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "kdo.cdsapis.xyz/Portfolio"
    }
  ];

  // 페이지 크기 (optional)
  optional int32 page_size = 2;

  // 페이지 토큰 (optional)
  optional string page_token = 3;
}

// ListPortfolioFunds 응답
message ListPortfolioFundsResponse {
  // 펀드 목록
  repeated FundSummary funds = 1;

  // 다음 페이지 토큰
  string next_page_token = 2;
}
