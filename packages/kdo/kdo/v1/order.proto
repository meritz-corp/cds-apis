syntax = "proto3";

package kdo.v1.order;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "kdo/v1/common.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/kdo/v1;kdo";

// OrderService는 직접 주문 제출 서비스를 제공합니다.
service OrderService {
  // 신규 주문 제출
  rpc SubmitOrder(SubmitOrderRequest) returns (SubmitOrderResponse) {
    option (google.api.http) = {
      post: "/v1/orders"
      body: "*"
    };
  }

  // 정정 주문
  rpc AmendOrder(AmendOrderRequest) returns (AmendOrderResponse) {
    option (google.api.http) = {
      post: "/v1/orders/{original_order_id}:amend"
      body: "*"
    };
  }

  // 취소 주문
  rpc CancelOrder(CancelOrderRequest) returns (CancelOrderResponse) {
    option (google.api.http) = {
      post: "/v1/orders/{original_order_id}:cancel"
      body: "*"
    };
  }

  // 미체결 주문 목록 조회
  rpc ListAllUnfilledOrders(ListAllUnfilledOrdersRequest) returns (ListAllUnfilledOrdersResponse) {
    option (google.api.http) = {
      get: "/v1/orders:unfilled"
    };
  }

  // 전체 주문 취소
  rpc CancelAllOrders(CancelAllOrdersRequest) returns (CancelAllOrdersResponse) {
    option (google.api.http) = {
      post: "/v1/orders:cancel_all"
      body: "*"
    };
  }
}

// ========== Enums ==========

enum QuoteType {
  QUOTE_TYPE_UNSPECIFIED = 0;
  QUOTE_TYPE_LIMIT = 1;   // 지정가
  QUOTE_TYPE_MARKET = 2;  // 시장가
  QUOTE_TYPE_BEST_TAKE = 3;  // 상대호가
  QUOTE_TYPE_BEST_MAKE = 4;  // 자기호가
}

enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0;
  ORDER_STATUS_SUBMITTED = 1;   // 주문 제출됨
  ORDER_STATUS_REJECTED = 2;    // 거부됨 (validation 실패)
}

enum OrderResultType {
  ORDER_RESULT_TYPE_UNSPECIFIED = 0;
  ORDER_RESULT_TYPE_RECEIVED = 1;    // 접수됨
  ORDER_RESULT_TYPE_REJECTED = 2;    // 거부됨
  ORDER_RESULT_TYPE_FILLED = 3;      // 체결됨
  ORDER_RESULT_TYPE_CANCELLED = 4;   // 취소됨
}

// ========== SubmitOrder ==========

message SubmitOrderRequest {
  // 펀드 코드 (필수)
  string fund_code = 1 [(google.api.field_behavior) = REQUIRED];

  // 종목 코드 ISIN (필수)
  string symbol = 2 [(google.api.field_behavior) = REQUIRED];

  // 매수/매도 (필수)
  kdo.v1.common.OrderSide side = 3 [(google.api.field_behavior) = REQUIRED];

  // 수량 (필수)
  int64 quantity = 4 [(google.api.field_behavior) = REQUIRED];

  // 가격 (필수, 시장가 주문 시 0)
  string price = 5 [(google.api.field_behavior) = REQUIRED];

  // 주문 유형 (기본: LIMIT)
  QuoteType quote_type = 6  [(google.api.field_behavior) = REQUIRED];

  // 유동성 공급자 여부
  bool is_lp = 7  [(google.api.field_behavior) = REQUIRED];
}

message SubmitOrderResponse {
  // 주문 ID
  uint64 order_id = 1;

  // 주문 상태
  OrderStatus status = 2;

  // 결과 메시지
  string message = 3;
}

// ========== AmendOrder ==========

message AmendOrderRequest {
  // 원주문 ID
  uint64 original_order_id = 1 [(google.api.field_behavior) = REQUIRED];

  // 펀드 코드
  string fund_code = 2 [(google.api.field_behavior) = REQUIRED];

  // 종목 코드
  string symbol = 3 [(google.api.field_behavior) = REQUIRED];

  // 정정 수량
  int64 quantity = 4 [(google.api.field_behavior) = REQUIRED];

  // 정정 가격
  string price = 5 [(google.api.field_behavior) = REQUIRED];

  // 매수/매도
  kdo.v1.common.OrderSide side = 6 [(google.api.field_behavior) = REQUIRED];

  // 유동성 공급자 여부
  bool is_lp = 7  [(google.api.field_behavior) = REQUIRED];
}

message AmendOrderResponse {
  // 신규 주문 ID
  uint64 order_id = 1;

  // 원주문 ID
  uint64 original_order_id = 2;

  // 주문 상태
  OrderStatus status = 3;

  // 결과 메시지
  string message = 4;
}

// ========== CancelOrder ==========

message CancelOrderRequest {
  // 원주문 ID
  uint64 original_order_id = 1 [(google.api.field_behavior) = REQUIRED];

  // 펀드 코드
  string fund_code = 2 [(google.api.field_behavior) = REQUIRED];

  // 종목 코드
  string symbol = 3 [(google.api.field_behavior) = REQUIRED];

  // 매수/매도
  kdo.v1.common.OrderSide side = 6 [(google.api.field_behavior) = REQUIRED];
}

message CancelOrderResponse {
  // 취소 주문 ID
  uint64 order_id = 1;

  // 원주문 ID
  uint64 original_order_id = 2;

  // 주문 상태
  OrderStatus status = 3;

  // 결과 메시지
  string message = 4;
}

// ========== ListAllUnfilledOrders ==========

message ListAllUnfilledOrdersRequest {
  // 펀드 코드 (optional, 미지정 시 전체 펀드)
  optional string fund_code = 1;

  // 종목 코드 (optional, 미지정 시 전체 종목)
  optional string symbol = 2;

  // 매수/매도 (optional, 미지정 시 양방향)
  optional kdo.v1.common.OrderSide side = 3;
}

message ListAllUnfilledOrdersResponse {
  // 미체결 주문 목록
  repeated Order orders = 1;
}

// ========== CancelAllOrders ==========

message CancelAllOrdersRequest {

}

message CancelAllOrdersResponse {
  // 취소 요청된 주문 수
  int32 cancelled_count = 1;

  // 결과 메시지
  string message = 2;
}

// ========== StreamOrderResults ==========

message StreamOrderResultsRequest {
  // 필터: 특정 펀드만 (optional)
  optional string fund_code = 1;

  // 필터: 특정 종목만 (optional)
  optional string symbol = 2;
}

message OrderResult {
  // 주문 ID
  uint64 order_id = 1;

  // 종목 코드
  string symbol = 2;

  // 펀드 코드
  string fund_code = 3;

  // 매수/매도
  kdo.v1.common.OrderSide side = 4;

  // 가격
  string price = 5;

  // 수량
  int64 quantity = 6;

  // 결과 유형
  OrderResultType result_type = 7;

  // 타임스탬프
  google.protobuf.Timestamp timestamp = 8;

  // result_type에 따른 추가 정보
  oneof details {
    ReceivedDetails received = 10;
    RejectedDetails rejected = 11;
    FilledDetails filled = 12;
    CancelledDetails cancelled = 13;
  }
}

message ReceivedDetails {
  // 접수 시간 (nanoseconds since epoch)
  uint64 receive_time = 1;
}

message RejectedDetails {
  // 거부 코드
  string rejection_code = 1;

  // 에러 메시지
  string error_message = 2;
}

message FilledDetails {
  // 체결 가격
  string filled_price = 1;

  // 체결 수량
  int64 filled_quantity = 2;

  // 체결 시간 (nanoseconds since epoch)
  uint64 trade_time = 3;
}

message CancelledDetails {
  // 취소 코드
  string cancellation_code = 1;

  // 취소 수량
  int64 cancelled_quantity = 2;
}


// 주문 목록 조회 요청
message ListOrdersRequest {
  // 필터링 조건 (선택적, AIP-160)
  string filter = 1;

  // 페이징 (AIP-158)
  int32 page_size = 2;
  string page_token = 3;
}

// 주문 목록 조회 응답
message ListOrdersResponse {
  // 주문 목록
  repeated Order orders = 1;

  // 다음 페이지 토큰 (AIP-158)
  string next_page_token = 2;
}

// 주문 정보
message Order {
  // 주문 ID
  string order_id = 1;

  // 주문 타입
  kdo.v1.common.OrderSide order_side = 2;

  // 상품 (예: etfs/A069500)
  string symbol = 3;

  // 주문 가격
  string price = 4;

  // 주문 수량
  int64 quantity = 5;

  // 체결 수량
  int64 filled_quantity = 6;

  // 주문 상태
  OrderStatus status = 7;

  // 주문 시간 (Unix timestamp)
  int64 created_at = 8;

  // 업데이트 시간 (Unix timestamp)
  int64 updated_at = 9;
}