syntax = "proto3";

package market_archive.v1.market;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

option go_package = "github.com/meritz-corp/cds-apis/go/market_archive/v1;market_archive";

// 호가 서비스
service OrderbookService {
  // 호가 이력 조회
  rpc GetOrderbooks(GetOrderbooksRequest) returns (GetOrderbooksResponse);

  // 최신 호가 조회
  rpc GetLatestOrderbook(GetLatestOrderbookRequest) returns (Orderbook);

  // 특정 시점 스냅샷
  rpc GetOrderbookSnapshot(GetOrderbookSnapshotRequest) returns (Orderbook);

  // 실시간 호가 스트림
  rpc SubscribeOrderbooks(SubscribeRequest) returns (stream OrderbookUpdate);
}

// 체결 서비스
service TradeService {
  // 체결 이력 조회
  rpc GetTrades(GetTradesRequest) returns (GetTradesResponse);

  // 실시간 체결 스트림
  rpc SubscribeTrades(SubscribeRequest) returns (stream TradeUpdate);
}

// OHLC 서비스
service CandleService {
  // OHLC 조회
  rpc GetCandles(GetCandlesRequest) returns (GetCandlesResponse);

  // 실시간 캔들 스트림 (진행중인 캔들 업데이트)
  rpc SubscribeCandles(GetCandlesRequest) returns (stream Candle);
}

// 종목 서비스
service SymbolService {
  // 종목 목록
  rpc ListSymbols(ListSymbolsRequest) returns (ListSymbolsResponse);

  // 종목 정보
  rpc GetSymbol(GetLatestOrderbookRequest) returns (SymbolInfo);
}

// 지표 서비스 (Phase 2)
service IndicatorService {
  // 지표 계산 조회
  rpc GetIndicator(GetIndicatorRequest) returns (GetIndicatorResponse);
}

// 적재 서비스 (Admin)
service IngestionService {
  // 단일 파일 적재
  rpc IngestFile(IngestFileRequest) returns (IngestFileResponse);

  // 디렉토리 일괄 적재
  rpc IngestDirectory(IngestDirectoryRequest) returns (IngestDirectoryResponse);
}


// 시간 범위 쿼리
message TimeRange {
  google.protobuf.Timestamp start = 1;
  google.protobuf.Timestamp end = 2;
}

// 페이지네이션
message Pagination {
  int32 limit = 1;   // 최대 반환 개수 (default: 1000, max: 10000)
  int32 offset = 2;  // 시작 위치
}

// 세션 ID (장 상태)
enum SessionId {
  SESSION_UNKNOWN = 0;
  SESSION_PREVIOUS = 1;           // 장개시전
  SESSION_OPENING_AUCTION = 2;    // 시가단일가
  SESSION_CONTINUOUS = 3;         // 접속 (정규장)
  SESSION_CLOSING_AUCTION = 4;    // 종가단일가
  SESSION_AFTER_HOURS = 5;        // 장종료후
  SESSION_VI_AUCTION = 6;         // VI단일가
  SESSION_CLOSED = 7;             // 장마감
}

// 매수/매도 구분
enum Side {
  SIDE_UNKNOWN = 0;
  SIDE_BID = 1;  // 매수
  SIDE_ASK = 2;  // 매도
}

// OHLC 간격
enum Interval {
  INTERVAL_UNKNOWN = 0;
  INTERVAL_1S = 1;    // 1초
  INTERVAL_5S = 2;    // 5초
  INTERVAL_10S = 3;   // 10초
  INTERVAL_30S = 4;   // 30초
  INTERVAL_1M = 5;    // 1분
  INTERVAL_5M = 6;    // 5분
  INTERVAL_15M = 7;   // 15분
  INTERVAL_30M = 8;   // 30분
  INTERVAL_1H = 9;    // 1시간
  INTERVAL_4H = 10;   // 4시간
  INTERVAL_1D = 11;   // 1일
}

// ============================================================================
// Orderbook (호가)
// ============================================================================

// 단일 호가 레벨
message PriceLevel {
  double price = 1;     // 가격
  int64 quantity = 2;   // 수량
  int32 count = 3;      // 건수 (선물만 해당)
}

// 호가 데이터
message Orderbook {
  string symbol = 1;
  google.protobuf.Timestamp time = 2;
  SessionId session_id = 3;

  repeated PriceLevel bids = 4;  // 매수 호가 (가격 내림차순)
  repeated PriceLevel asks = 5;  // 매도 호가 (가격 오름차순)

  double mid_price = 6;          // 중간 가격
  double spread = 7;             // 스프레드

  // 총 수량
  int64 total_bid_quantity = 8;
  int64 total_ask_quantity = 9;

  // 예상 체결가/수량 (단일가 시)
  double estimated_price = 10;
  int64 estimated_volume = 11;
}

// 호가 조회 요청
message GetOrderbooksRequest {
  string symbol = 1;
  TimeRange time_range = 2;
  Pagination pagination = 3;
}

// 호가 조회 응답
message GetOrderbooksResponse {
  repeated Orderbook orderbooks = 1;
  int32 total_count = 2;
  bool has_more = 3;
}

// 최신 호가 조회 요청
message GetLatestOrderbookRequest {
  string symbol = 1;
}

// 호가 스냅샷 조회 (특정 시점)
message GetOrderbookSnapshotRequest {
  string symbol = 1;
  google.protobuf.Timestamp at = 2;  // 해당 시점 또는 직전 호가
}

// ============================================================================
// Trade (체결)
// ============================================================================

// 체결 데이터
message Trade {
  string symbol = 1;
  google.protobuf.Timestamp time = 2;
  double price = 3;
  int64 quantity = 4;
  Side side = 5;

  // 누적 데이터
  int64 cumulative_volume = 6;
  double cumulative_value = 7;
}

// 체결 조회 요청
message GetTradesRequest {
  string symbol = 1;
  TimeRange time_range = 2;
  Pagination pagination = 3;
  Side side_filter = 4;  // 선택적 필터
}

// 체결 조회 응답
message GetTradesResponse {
  repeated Trade trades = 1;
  int32 total_count = 2;
  bool has_more = 3;
}

// ============================================================================
// OHLC (캔들)
// ============================================================================

// OHLC 캔들 데이터
message Candle {
  string symbol = 1;
  google.protobuf.Timestamp time = 2;  // 캔들 시작 시간
  Interval interval = 3;

  double open = 4;
  double high = 5;
  double low = 6;
  double close = 7;
  int64 volume = 8;
  double value = 9;      // 거래대금
  int32 trade_count = 10; // 체결 건수
}

// OHLC 조회 요청
message GetCandlesRequest {
  string symbol = 1;
  Interval interval = 2;
  TimeRange time_range = 3;
  Pagination pagination = 4;
}

// OHLC 조회 응답
message GetCandlesResponse {
  repeated Candle candles = 1;
  int32 total_count = 2;
  bool has_more = 3;
}

// ============================================================================
// Symbol (종목)
// ============================================================================

enum MarketType {
  MARKET_UNKNOWN = 0;
  MARKET_KOSPI = 1;
  MARKET_KOSDAQ = 2;
  MARKET_ETF = 3;
  MARKET_FUTURES = 4;
  MARKET_OPTIONS = 5;
}

message SymbolInfo {
  string symbol = 1;
  string name = 2;
  MarketType market_type = 3;
  string underlying = 4;      // 기초자산 (파생만 해당)
  double tick_size = 5;       // 호가 단위
  int32 lot_size = 6;         // 거래 단위
}

message ListSymbolsRequest {
  MarketType market_type = 1;  // 선택적 필터
}

message ListSymbolsResponse {
  repeated SymbolInfo symbols = 1;
}

// ============================================================================
// Indicator (기술적 지표) - Phase 2
// ============================================================================

enum IndicatorType {
  INDICATOR_UNKNOWN = 0;
  INDICATOR_SMA = 1;      // 단순 이동평균
  INDICATOR_EMA = 2;      // 지수 이동평균
  INDICATOR_MACD = 3;     // MACD
  INDICATOR_RSI = 4;      // RSI
  INDICATOR_BOLLINGER = 5; // 볼린저 밴드
  INDICATOR_VWAP = 6;     // VWAP
  INDICATOR_ATR = 7;      // ATR
}

message IndicatorParams {
  IndicatorType type = 1;
  repeated int32 periods = 2;  // 기간 파라미터 (예: [12, 26, 9] for MACD)
  double std_dev = 3;          // 표준편차 (볼린저용)
}

message IndicatorValue {
  google.protobuf.Timestamp time = 1;
  repeated double values = 2;  // 지표 값들 (MACD면 [macd, signal, histogram])
}

message GetIndicatorRequest {
  string symbol = 1;
  Interval interval = 2;
  IndicatorParams params = 3;
  TimeRange time_range = 4;
}

message GetIndicatorResponse {
  string symbol = 1;
  IndicatorParams params = 2;
  repeated IndicatorValue values = 3;
}

// ============================================================================
// Streaming (실시간)
// ============================================================================

message SubscribeRequest {
  repeated string symbols = 1;
}

message OrderbookUpdate {
  Orderbook orderbook = 1;
}

message TradeUpdate {
  Trade trade = 1;
}

// ============================================================================
// Ingestion (적재) - Admin용
// ============================================================================

message IngestFileRequest {
  string file_path = 1;
  bool skip_duplicates = 2;  // 중복 스킵 여부
}

message IngestFileResponse {
  int64 total_lines = 1;
  int64 parsed_count = 2;
  int64 inserted_count = 3;
  int64 skipped_count = 4;
  int64 error_count = 5;
  repeated string errors = 6;  // 처음 10개 에러만
}

message IngestDirectoryRequest {
  string directory_path = 1;
  string file_pattern = 2;     // glob 패턴 (예: "*.txt")
  bool skip_duplicates = 3;
}

message IngestDirectoryResponse {
  int32 file_count = 1;
  repeated IngestFileResponse results = 2;
}

